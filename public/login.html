<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Assigned Passkey</title>
    <style>
        /* Previous styles */
    </style>
</head>
<body>
    <div class="container">
        <h2>Login with Assigned Passkey</h2>
        <div class="form-group">
            <input type="email" id="email" placeholder="Enter your email" autocomplete="username webauthn">
        </div>
        <button onclick="startLogin()" id="loginButton">Login with Security Key</button>
        <div id="status" class="status"></div>
        <div id="error" class="error"></div>
    </div>

    <script>
        // Previous buffer utils...
        const bufferUtils = {
            bufferToBase64url(buffer) {
                const array = new Uint8Array(buffer);
                let string = '';
                for (let i = 0; i < array.length; i++) {
                    string += String.fromCharCode(array[i]);
                }
                const base64 = btoa(string);
                return base64.replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            },

            base64urlToBuffer(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const padding = '='.repeat((4 - base64.length % 4) % 4);
                const binary = atob(base64 + padding);
                const buffer = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    buffer[i] = binary.charCodeAt(i);
                }
                return buffer.buffer;
            }
        };

        async function startLogin() {
            const email = document.getElementById('email').value;
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');
            const button = document.getElementById('loginButton');

            try {
                if (!email) {
                    throw new Error('Please enter your email');
                }

                button.disabled = true;
                errorEl.textContent = '';
                statusEl.textContent = 'Starting authentication...';

                // Start authentication
                const startResponse = await fetch('/api/user/login/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    throw new Error(error.message || 'Failed to start authentication');
                }

                const { data } = await startResponse.json();
                console.log('Auth options:', data);

                // Convert challenge and credential IDs
                const options = {
                    ...data.options,
                    challenge: bufferUtils.base64urlToBuffer(data.options.challenge),
                    allowCredentials: data.options.allowCredentials?.map(cred => ({
                        ...cred,
                        id: bufferUtils.base64urlToBuffer(cred.id)
                    }))
                };

                statusEl.textContent = 'Please use your security key...';

                // Get credential
                const credential = await navigator.credentials.get({
                    publicKey: options
                });

                console.log('Got credential:', credential);

                // Format assertion for server
                const assertionResponse = {
                    id: credential.id,
                    rawId: bufferUtils.bufferToBase64url(credential.rawId),
                    response: {
                        clientDataJSON: bufferUtils.bufferToBase64url(
                            credential.response.clientDataJSON
                        ),
                        authenticatorData: bufferUtils.bufferToBase64url(
                            credential.response.authenticatorData
                        ),
                        signature: bufferUtils.bufferToBase64url(
                            credential.response.signature
                        ),
                        userHandle: credential.response.userHandle ? 
                            bufferUtils.bufferToBase64url(credential.response.userHandle) : null
                    },
                    type: credential.type
                };

                statusEl.textContent = 'Verifying...';

                // Complete authentication
                const completeResponse = await fetch('/api/user/login/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        assertionResponse
                    })
                });

                if (!completeResponse.ok) {
                    const error = await completeResponse.json();
                    throw new Error(error.message || 'Authentication failed');
                }

                const result = await completeResponse.json();
                console.log('Auth result:', result);

                if (result.data?.token) {
                    localStorage.setItem('authToken', result.data.token);
                    statusEl.textContent = 'Login successful! Redirecting...';
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    throw new Error('No token received');
                }

            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = error.message;
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>